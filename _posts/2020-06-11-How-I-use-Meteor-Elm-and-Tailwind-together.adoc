// = Your Blog title
// See https://hubpress.gitbooks.io/hubpress-knowledgebase/content/ for information about the parameters.
// :hp-image: /covers/cover.png
// :published_at: 2019-01-31
// :hp-tags: HubPress, Blog, Open_Source,
// :hp-alt-title: My English Title

= How I use Meteor, Elm and Tailwind together
:published_at: 2020-06-11
:hp-tags: meteor, elm, parcel, tailwind
:toc:

I worked with Elm last year and honestly it was an excellent experience.
I really like it and I would like to use Elm in all my new projects.
But I also like Meteor and three weeks ago I started using it again.
I discovered Meteor in 2015, I gave a talk about it (https://www.youtube.com/watch?v=AxIvfQXTqVo) and it still feels like "Wow!" when you start a project.
So in this post I'll explain how I make the two work together, adding tailwind for the UI part (because I love tailwind too üòç) from scratch.


== Prerequisite

You only need two things:

- Your favourite IDE (VSCode with the https://marketplace.visualstudio.com/items?itemName=Elmtooling.elm-ls-vscode[Elm extension] fits very well)
- A browser

You don't need to install NPM, Node or Mongo.
All this stuff is already packaged in Meteor environment.

So to run a NPM command we will use `meteor npm xxx`, and for Mongo, we will use `meteor mongo`.

So let's begin üòÅ

== Meteor

=== Install Meteor

image::https://user-images.githubusercontent.com/2006548/84738510-53981b80-afaa-11ea-8d02-cdf6c42c26c0.png[]

Here are the commands to install Meteor on OSX/Linux and Windows
OSX / Linux

```shell
# OSX/Linux
curl https://install.meteor.com/ | sh

# Windows
choco install meteor
```

NOTE: For more informations about the installation, you can go here https://www.meteor.com/install

=== Create a project

Let's start by creating an empty project

```shell
meteor create meteor-elm-app --bare
cd meteor-elm-app
```

This command will create an empty project with static-html instead of blaze and without autopublish and insecure

NOTE: For more informations about the command create, you can go here https://docs.meteor.com/commandline.html#meteorcreate


=== Add typescript

Adding Typescript is really simple, run these two commands

```shell
# under meteor-elm-app
meteor add typescript
meteor npm i -D @types/meteor @types/mocha
```

Create a tsconfig.json under the directory `meteor-elm-app`
```json
{
    "compilerOptions": {
      /* Basic Options */
      "target": "es2018",
      "module": "esNext",
      "lib": ["esnext", "dom"],
      "allowJs": true,
      "checkJs": false,
      "incremental": false,
      "noEmit": true,
  
      /* Strict Type-Checking Options */
      "strict": true,
      "noImplicitAny": true,
      "strictNullChecks": true,
  
      /* Additional Checks */
      "noUnusedLocals": true,
      "noUnusedParameters": true,
      "noImplicitReturns": false,
      "noFallthroughCasesInSwitch": false,
  
      /* Module Resolution Options */
      "baseUrl": ".",
      "paths": {
        /* Support absolute ~imports/* with a leading '/' */
        "/*": ["*"]
      },
      "moduleResolution": "node",
      "resolveJsonModule": true,
      "types": ["node", "mocha"],
      "esModuleInterop": true,
      "preserveSymlinks": true,
    },
    "exclude": [
      "./.meteor/**",
      "./packages/**"
    ]
  }
```

NOTE: This configuration comes from the typescript template provided by Meteor.
I just removed the support of JSX.

=== Create the file structure

NOTE: We will setup a simple file structure here, for more complex projects, you should follow the guideline provided by Meteor https://guide.meteor.com/structure.html#javascript-structure

Run these commands
```shell
# under meteor-elm-app
mkdir client server imports/api
touch client/main.html client/main.ts client/main.css server/main.ts
```

Your folder should be like this:

```shell
# under meteor-elm-app
‚ùØ tree -I node_modules                                              
.
‚îú‚îÄ‚îÄ client
‚îÇ¬†¬† ‚îú‚îÄ‚îÄ main.css
‚îÇ¬†¬† ‚îú‚îÄ‚îÄ main.html
‚îÇ¬†¬† ‚îî‚îÄ‚îÄ main.ts
‚îú‚îÄ‚îÄ imports
‚îÇ¬†¬† ‚îî‚îÄ‚îÄ api
‚îú‚îÄ‚îÄ package-lock.json
‚îú‚îÄ‚îÄ package.json
‚îî‚îÄ‚îÄ server
    ‚îî‚îÄ‚îÄ main.ts

4 directories, 6 files
```

We will update the `package.json` file to define the main modules in our Meteor app:

```json
"meteor": {
    "mainModule": {
        "client": "client/main.ts",
        "server": "server/main.ts"
    }
}
```

At this time your `package.json` file should be like:
```json
{
  "name": "meteor-elm-app",
  "private": true,
  "scripts": {
    "start": "meteor run"
  },
  "meteor": {
    "mainModule": {
      "client": "client/main.ts",
      "server": "server/main.ts"
    }
  },
  "dependencies": {
    "@babel/runtime": "^7.8.3",
    "meteor-node-stubs": "^1.0.0"
  }
}

```

NOTE: if you need more informations about this mainModule options, you can read the content of this pull request https://github.com/meteor/meteor/pull/9690

We need now to add some basic content to the `main.html` file:

```html
<head>
  <title>meteor-elm-app</title>
</head>

<body>
  <div id="main">Elm app will be here</div>
</body>
```

=== Checkpoint

Let's check if everything is OK before starting with Elm.
Start your `meteor` server: 
```shell
# under meteor-elm-app
meteor
```

Open http://localhost:3000 on your favorite browser
You should see this:

image::https://user-images.githubusercontent.com/2006548/84446744-8195fc80-ac46-11ea-9da8-4fd2033898bf.png[]


== Elm

=== Install Parcel

We will use Parcel to build our Elm application and we will use the result of this build in our Meteor application

To install Parcel, run this command

```shell
meteor npm i -D parcel
```

=== Install Elm

To install Elm, run this command

```shell
meteor npm i -D elm elm-format
```

NOTE: elm-format is not mandatory but you should use it with your IDE to format on save and avoid problem at compile time

We will also create a `script` in the `package.json` to call Elm easily like:
```shell
meteor npm run elm
```

In your package.json, add this `elm` script:
```json
"scripts": {
    "elm": "elm",
    "start": "meteor run"
},
```

You can validate your script by running:
```shell
meteor npm run elm -- --version
```

You should see the version of Elm:
```
> elm "--version"

0.19.1
```


=== Create a package
create  folders

```shell
mkdir -p packages/elm-app/{app,dist}
```

because we will build with parcel and not with meteor, we will create a new file at the root of the meteor-elm-app called `.meteorignore`

```
/packages/elm-app/app/**/*
```

because we don't want to push the dist and the `elm-stuff` folders on our repository, we will add them in the .gitignore
```
dist
elm-stuff
```

create a file package.js inside this folder:
```js
Package.describe({
    name: 'elm-app',
    version: '1.0.0',
    summary: 'elm app',
    documentation: 'add your elm app into meteor',
});

Package.onUse(function (api) {
    api.versionsFrom('1.10.2');
    api.use('modules');
    api.addFiles('dist/elm-app.css', 'client');
    api.mainModule('dist/elm-app.js', 'client');
});
```
explain, link to the doc

=== Create the app

it will ignore changes in this folder, and avoid meteor to reload each time we change stuff in this folder. 

into the folder `packages/elm-app/app`
run
```shell
../../../node_modules/.bin/elm init
```

in `packages/elm-app/app/src`, create your `Main.elm` file

```elm
module Main exposing(main)

import Browser
import Html exposing (Html, text)

type alias Model = String

main : Program () Model msg
main =
    Browser.element
        { init = init
        , view = view
        , update = update
        , subscriptions = subscriptions
        }

init: () -> (Model, Cmd msg)
init _ =
    ("Hello from Elm app", Cmd.none)

view: Model -> Html msg
view model =
    text model

update: msg -> Model -> (Model, Cmd msg)
update _ model =
    (model, Cmd.none)

subscriptions : Model -> Sub msg
subscriptions _ =
    Sub.none
```

=== The CSS main file
under the folder app
Create an empty CSS file (or SCSS if you prefer) that we will use to add some style in our Elm app

NB: if you use `elm-css` and you don't need a stylesheet, skip this step and remove the line `api.addFiles('dist/elm-app.css', 'client');` in the package.js file

=== The app entrypoint
under the folder app
Create an index.ts file under your app folder (take care of the first line if you don't use SCSS but a `main.css` file )

```ts
import './main.scss'
const { Elm } = require('./src/Main.elm')

interface Flags {}

export interface Configuration {
    node: HTMLElement | null,
    flags: Flags
}

export interface Ports {}

export const init: (configuration: Configuration) => Ports = (configuration) => {
    const app = Elm.Main.init(configuration)
    return app.ports
}
```

=== Build with parcel
But... wait... why do we use Parcel? Why don't we use the Elm make command? Why don't we use the Meteor bundler for css?

It is a personal choice, imo using Parcel is easier to build my Elm app, mixing Elm, TS and SCSS. Also it is easier to use Tailwind, because most of the packages I found (PostCSS, PurgeCSS) where not maintened anymore.

Because the dist content does not exist yet, we must build a first time manually with parcel

update the `package.json` file to add the script
```js
"elm:build": "parcel build packages/elm-app/app/index.ts -d packages/elm-app/dist --out-file elm-app.js --no-cache",
```

and run
```
meteor npm run elm:build
```

If everthing is ok, you should see

image::https://user-images.githubusercontent.com/2006548/84450020-4ea43680-ac4f-11ea-9b45-ce0dfb572835.png[]

=== Add our meteor package
in your shell, execute
```
meteor add elm-app
```

You should see

image::https://user-images.githubusercontent.com/2006548/84450082-7abfb780-ac4f-11ea-92f4-db936ee6f726.png[]

=== Post install
To avoid to have to compile manually each time someone clone the repository, we will add a `postinstall` script:

```json
"postinstall": "npm run elm:build",
```

== Use the Elm in our Meteor client
Now that we have our Elm application, it is time to import it in the client part of our Meteor application

update your `client/main.ts`

```ts
import { init } from "meteor/elm-app";
import { Meteor } from 'meteor/meteor';

Meteor.startup(() => {
    const ports = init({
        node: document.getElementById("main"),
        flags: {}
    })
})
```

Now, if you start your meteor application by running the `meteor` command, you should see:

image::https://user-images.githubusercontent.com/2006548/84450699-4a791880-ac51-11ea-9c51-c0046cc273a0.png[]

But...

=== The typing is not good
You should see that your import is underline with red:

image::https://user-images.githubusercontent.com/2006548/84450825-9c21a300-ac51-11ea-9243-78a13ecad82d.png[]

To fix that, we will a declaration file `<ROOT>/types/meteor/elm-app.d.ts`

```ts
declare module 'meteor/elm-app' {
    export const init: (
        configuration: import('~packages/elm-app/app').Configuration,
    ) => import('~packages/elm-app/app').Ports;
}
```

Now each time I will change the definition of the Flag type or the Port type inside my Elm application, I will be sure to know if I have some stuff to fix üí™

== Live Reload
Because we don't want to build manually our Elm application each time we make a change, we will setup the live reload

first install this packages
```shell
meteor npm i -D concurrently wait-on rimraf
```

then we will create an new script entry:

```json
"elm:watch": "parcel watch packages/elm-app/app/index.ts -d packages/elm-app/dist --out-file elm-app.js",
```

With `elm:watch`, parcel will rebuild our app each time we make a change in Elm, TS or SCSS files.

Now to run parcel and meteor in //, we will rename the script `start` to `meteor:run`, and redefine the `start`:

```json
"meteor:run": "meteor run",
"start": "rimraf \"./packages/elm-app/dist/*\" && concurrently -n \"parcel,meteor\" -c \"magenta,green\" \"meteor npm run elm:watch\" \"wait-on ./packages/elm-app/dist/elm-app.js && meteor npm run meteor:run\"",
```

And because `parcel watch` create a `.cache` folder, we will add it to the `.gitignore` file.

== Tailwind

https://tailwindcss.com/docs/installation
```
meteor npm i -D tailwindcss
```

```
cd packages/elm-app/app
npx tailwindcss init
```

edit main.scss

```
@tailwind base;
@tailwind components;
@tailwind utilities;
```

postcss.config.js
```
module.exports = {
  plugins: [
      require("tailwindcss"),
      require("autoprefixer")
    ],
};

```

edit Main.elm
```
view: Model -> Html msg
view model =
    div [class "text-green-500"] [text model]
```


image::https://user-images.githubusercontent.com/2006548/84566211-bfdb0b00-ad6f-11ea-86fa-927a901ae327.png[]


== The TODO app
```
../../../node_modules/.bin/elm install elm/svg elm/json NoRedInk/elm-json-decode-pipeline
```

== Conclusion

Congratulations üéâ! You made your first application with Elm and Meteor üëè.










