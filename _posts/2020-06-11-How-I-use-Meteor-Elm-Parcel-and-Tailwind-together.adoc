// = Your Blog title
// See https://hubpress.gitbooks.io/hubpress-knowledgebase/content/ for information about the parameters.
// :hp-image: /covers/cover.png
// :published_at: 2019-01-31
// :hp-tags: HubPress, Blog, Open_Source,
// :hp-alt-title: My English Title

= How I use Meteor, Elm, Parcel and Tailwind together
:published_at: 2020-06-11
:hp-tags: meteor, elm, parcel, tailwind

== Install Meteor
```shell
curl ...
```

=== Create a project

```shell
meteor create meteor-elm-app
```

=== Add typescript
```shell
meteor add typescript
meteor npm i -D @types/meteor @types/mocha
```

tsconfig.json
```json
{
    "compilerOptions": {
      /* Basic Options */
      "target": "es2018",
      "module": "esNext",
      "lib": ["esnext", "dom"],
      "allowJs": true,
      "checkJs": false,
      "incremental": false,
      "noEmit": true,
  
      /* Strict Type-Checking Options */
      "strict": true,
      "noImplicitAny": true,
      "strictNullChecks": true,
  
      /* Additional Checks */
      "noUnusedLocals": true,
      "noUnusedParameters": true,
      "noImplicitReturns": false,
      "noFallthroughCasesInSwitch": false,
  
      /* Module Resolution Options */
      "baseUrl": ".",
      "paths": {
        /* Support absolute ~imports/* with a leading '/' */
        "~*": ["*"]
      },
      "moduleResolution": "node",
      "resolveJsonModule": true,
      "types": ["node", "mocha"],
      "esModuleInterop": true,
      "preserveSymlinks": true,
    },
    "exclude": [
      "./.meteor/**",
      "./packages/**"
    ]
  }
```

=== Clean stuff

Remove useless stuff


meteor remove blaze-html-template jquery
meteor npm uninstall jquery

meteor add static-html

clean client/main.css
client/main.js -> client/main.ts
server/main.js -> server/main.ts
tests/main.js -> tests/main.ts
clean main.html
```html
<head>
  <title>meteor-elm-app</title>
</head>

<body>
  <div id="main">Elm app will be here</div>
</body>
```

package.json : use ts extension instead of js in mainModule

=== Checkpoint
At this time if your run 
```
meteor
```

You should see 

image::https://user-images.githubusercontent.com/2006548/84446744-8195fc80-ac46-11ea-9da8-4fd2033898bf.png[]



== Elm application

=== Install Parcel

```shell
meteor npm i -D parcel
``

=== Install Elm

```shell
meteor npm i -D elm
```


=== Create a package
create  folders

```shell
mkdir -p packages/elm-app/{app,dist}
```

because we will build with parcel and not with meteor, we will create a new file at the root of the meteor-elm-app called `.meteorignore`

```
/packages/elm-app/app/**/*
```

because we don't want to push dist folder on our repository, we will add it in the .gitignore
```
dist
```

create a file package.js inside this folder:
```js
Package.describe({
    name: 'elm-app',
    version: '1.0.0',
    summary: 'elm app',
    documentation: 'add your elm app into meteor',
});

Package.onUse(function (api) {
    api.versionsFrom('1.10.2');
    api.use('modules');
    api.addFiles('dist/elm-app.css', 'client');
    api.mainModule('dist/elm-app.js', 'client');
});
```
explain, link to the doc

=== Create the app

it will ignore changes in this folder, and avoid meteor to reload each time we change stuff in this folder. 

into the folder `packages/elm-app/app`
run
```shell
../../../node_modules/.bin/elm init
```

in `packages/elm-app/app/src`, create your `Main.elm` file

```elm
module Main exposing(main)

import Browser
import Html exposing (Html, text)

type alias Model = String

main : Program () Model msg
main =
    Browser.element
        { init = init
        , view = view
        , update = update
        , subscriptions = subscriptions
        }

init: () -> (Model, Cmd msg)
init _ =
    ("Hello from Elm app", Cmd.none)

view: Model -> Html msg
view model =
    text model

update: msg -> Model -> (Model, Cmd msg)
update _ model =
    (model, Cmd.none)

subscriptions : Model -> Sub msg
subscriptions _ =
    Sub.none
```

=== The CSS main file
under the folder app
Create an empty CSS file (or SCSS if you prefer) that we will use to add some style in our Elm app

NB: if you use `elm-css` and you don't need a stylesheet, skip this step and remove the line `api.addFiles('dist/elm-app.css', 'client');` in the package.js file

=== The app entrypoint
under the folder app
Create an index.ts file under your app folder (take care of the first line if you don't use SCSS but a `main.css` file )

```ts
import './main.scss'
const { Elm } = require('./src/Main.elm')

interface Flags {}

export interface Configuration {
    node: HTMLElement | null,
    flags: Flags
}

export interface Ports {}

export const init: (configuration: Configuration) => Ports = (configuration) => {
    const app = Elm.Main.init(configuration)
    return app.ports
}
```

=== Build with parcel
Because the dist content does not exist yet, we must build a first time manually with parcel

update the `package.json` file to add the script
```js
"elm:build": "parcel build packages/elm-app/app/index.ts -d packages/elm-app/dist --out-file elm-app.js --no-cache",
```

and run
```
meteor npm run elm:build
```

If everthing is ok, you should see

image::https://user-images.githubusercontent.com/2006548/84450020-4ea43680-ac4f-11ea-9b45-ce0dfb572835.png[]

=== Add our meteor package
in your shell, execute
```
meteor add elm-app
```

You should see

image::https://user-images.githubusercontent.com/2006548/84450082-7abfb780-ac4f-11ea-92f4-db936ee6f726.png[]

=== Post install
To avoid to have to compile manually each time someone clone the repository, we will add a `postinstall` script:

```json
"postinstall": "npm run elm:build",
```

== Use the Elm in our client
Now that we have our Elm application, it is time to import it in the client part of our Meteor application

update your `client/main.ts`

```ts
import { init } from "meteor/elm-app";
import { Meteor } from 'meteor/meteor';

Meteor.startup(() => {
    const ports = init({
        node: document.getElementById("main"),
        flags: {}
    })
})
```

Now, if you start your meteor application by running the `meteor` command, you should see:

image::https://user-images.githubusercontent.com/2006548/84450699-4a791880-ac51-11ea-9c51-c0046cc273a0.png[]

But...

=== The typing is not good
You should see that your import is underline with red:

image::https://user-images.githubusercontent.com/2006548/84450825-9c21a300-ac51-11ea-9243-78a13ecad82d.png[]

To fix that, we will a declaration file `<ROOT>/types/meteor/elm-app.d.ts`

```ts
declare module 'meteor/elm-app' {
    export const init: (
        configuration: import('~packages/elm-app/app').Configuration,
    ) => import('~packages/elm-app/app').Ports;
}
```

Now each time I will change the definition of the Flag type or the Port type inside my Elm application, I will be sure to know if I have some stuff to fix 💪



== Install Tailwind


== Conclusion

Congratulations 🎉! You made your first application with Elm and Meteor 👏.










